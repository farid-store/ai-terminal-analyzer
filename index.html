<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Market Dashboard â€” Heatmaps, News, Stories, Gemini AI Chat</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script> 
    <style>
        /* Modern scrollbar for dark theme */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }

        /* tradingview sizing helpers */
        .tradingview-widget-container { width: 100%; height: 100%; }
        .tradingview-widget-container__widget { width: 100%; height: 100%; }

        /* Main Grid: Responsive adjustment */
        .layout-grid-new {
            display: grid;
            /* Default Desktop: Chart + Forex (2fr) | Heatmaps S/C (1fr) | News (380px) */
            grid-template-columns: 2fr 1fr 380px; 
            gap: 1.5rem; 
        }
        @media (max-width: 1400px) {
            .layout-grid-new { grid-template-columns: 2fr 1fr 300px; }
        }
        @media (max-width: 1200px) {
            .layout-grid-new { grid-template-columns: 3fr 2fr; }
        }
        @media (max-width: 1024px) {
            .layout-grid-new { 
                grid-template-columns: 1fr;
                /* Resetting explicit height for responsiveness */
                & > :nth-child(1) { height: auto !important; }
                & > :nth-child(2) { height: auto !important; }
                & > :nth-child(3) { height: auto !important; }
            }
        }
    </style>
</head>
<body class="bg-gray-950 text-slate-100 antialiased font-sans">

<script>
    // =========================================================================
    // ðŸ›‘ KUNCI API ANDA DIMASUKKAN DI SINI. INI SANGAT TIDAK AMAN!
    const GEMINI_API_KEY = "AIzaSyBD22OZdh4V0ypkIj2DfG1wHcY_6KYLcCU"; 
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models"; 
    // =========================================================================

    // Model IDs
    const TEXT_MODEL = "gemini-2.5-flash"; 
    const MULTIMODAL_MODEL = "gemini-2.5-flash"; 
</script>

<script>
    const rawData = [
        // --- Periode 2015 (Pasca The Fed Tapering) ---
        { monthYear: "Jan 2015", trend: "Ranging", desc: "Konsolidasi di tengah penguatan Dolar AS.", factor: "Kekuatan Dolar AS pasca berakhirnya Quantitative Easing (QE) The Fed." },
        { monthYear: "Feb 2015", trend: "Downtrend", desc: "Penurunan tajam, momentum bearish kuat.", factor: "Ekspektasi kenaikan suku bunga AS (Rate Hike)." },
        { monthYear: "Mar 2015", trend: "Ranging", desc: "Sideways/konsolidasi di area support.", factor: "Pasar mencerna data ekonomi AS yang beragam." },
        { monthYear: "Apr 2015", trend: "Uptrend", desc: "Rebound teknikal yang kuat.", factor: "Kelemahan sementara pada DXY (Indeks Dolar AS)." },
        { monthYear: "Mei 2015", trend: "Downtrend", desc: "Tren bearish dominan, gagal menembus resistance.", factor: "Pemulihan ekonomi AS & inflasi yang tetap rendah." },
        { monthYear: "Jun 2015", trend: "Downtrend", desc: "Penurunan berkelanjutan menuju level terendah.", factor: "Krisis utang Yunani kembali memicu ketidakpastian Eurozone." },
        { monthYear: "Jul 2015", trend: "Downtrend tajam", desc: "Penurunan drastis, terendah multi-tahun.", factor: "Kepastian kenaikan suku bunga Fed mendekat." },
        { monthYear: "Agu 2015", trend: "Ranging", desc: "Rebound & konsolidasi dari level rendah.", factor: "Devaluasi Yuan Tiongkok yang memicu volatilitas pasar." },
        { monthYear: "Sep 2015", trend: "Downtrend", desc: "Tekanan jual kembali dominan.", factor: "The Fed menunda kenaikan suku bunga pertamanya." },
        { monthYear: "Okt 2015", trend: "Uptrend", desc: "Kenaikan moderat dari bottom.", factor: "Data non-farm payroll (NFP) AS yang lemah." },
        { monthYear: "Nov 2015", trend: "Downtrend", desc: "Turun tajam, tembus support krusial.", factor: "Dolar AS menguat tajam, Fed bersiap naikkan suku bunga." },
        { monthYear: "Des 2015", trend: "Ranging", desc: "Sideways di area bawah, menunggu Rate Hike.", factor: "**The Fed menaikkan suku bunga untuk pertama kali (Des 2015).**" },
        // --- Periode 2016 (Pasca Rate Hike Pertama) ---
        { monthYear: "Jan 2016", trend: "Uptrend kuat", desc: "Rebound masif dari level terendah.", factor: "Kekacauan pasar saham global (khususnya Tiongkok) & harga minyak jatuh." },
        { monthYear: "Feb 2016", trend: "Uptrend", desc: "Momentum bullish berlanjut.", factor: "Peningkatan permintaan safe haven." },
        { monthYear: "Mar 2016", trend: "Ranging", desc: "Konsolidasi di area tinggi.", factor: "The Fed bersikap dovish (perlambatan kenaikan suku bunga)." },
        { monthYear: "Apr 2016", trend: "Downtrend", desc: "Koreksi setelah kenaikan panjang.", factor: "Kekuatan Dolar AS sementara." },
        { monthYear: "Mei 2016", trend: "Downtrend", desc: "Penurunan harga yang stabil.", factor: "Ekspektasi kenaikan suku bunga Fed (Rate Hike kedua)." },
        { monthYear: "Jun 2016", trend: "Uptrend tajam", desc: "Lonjakan harga yang sangat kuat.", factor: "**Keputusan Brexit (Inggris keluar dari Uni Eropa).**" },
        { monthYear: "Jul 2016", trend: "Ranging", desc: "Konsolidasi pasca Brexit, volatilitas tinggi.", factor: "Intervensi bank sentral pasca Brexit." },
        { monthYear: "Agu 2016", trend: "Downtrend", desc: "Koreksi wajar setelah lonjakan Juni.", factor: "Data ekonomi AS yang membaik." },
        { monthYear: "Sep 2016", trend: "Ranging", desc: "Pergerakan mendatar, tidak ada arah jelas.", factor: "The Fed tetap menahan suku bunga." },
        { monthYear: "Okt 2016", trend: "Downtrend", desc: "Penurunan yang stabil.", factor: "Penguatan Dolar AS menjelang pemilu AS." },
        { monthYear: "Nov 2016", trend: "Downtrend tajam", desc: "Penjualan besar-besaran pasca pemilu AS.", factor: "**Kemenangan Donald Trump (Janji stimulus fiskal besar).**" },
        { monthYear: "Des 2016", trend: "Downtrend", desc: "Tekanan jual berlanjut hingga akhir tahun.", factor: "**The Fed menaikkan suku bunga (Rate Hike kedua).**" },
        // --- Periode 2017 (Normalisasi Fed) ---
        { monthYear: "Jan 2017", trend: "Uptrend", desc: "Rebound awal tahun dari level rendah.", factor: "Melemahnya USD pasca kenaikan suku bunga." },
        { monthYear: "Feb 2017", trend: "Uptrend", desc: "Kenaikan stabil.", factor: "Ketidakpastian kebijakan Trump." },
        { monthYear: "Mar 2017", trend: "Uptrend", desc: "Mencapai puncak kuartalan.", factor: "**The Fed menaikkan suku bunga (Rate Hike ketiga).**" },
        { monthYear: "Apr 2017", trend: "Ranging", desc: "Konsolidasi di area atas.", factor: "Ketegangan geopolitik AS-Korea Utara." },
        { monthYear: "Mei 2017", trend: "Downtrend", desc: "Koreksi wajar.", factor: "Penguatan Dolar AS." },
        { monthYear: "Jun 2017", trend: "Ranging", desc: "Sideways di area support.", factor: "**The Fed menaikkan suku bunga (Rate Hike keempat).**" },
        { monthYear: "Jul 2017", trend: "Uptrend", desc: "Rebound yang kuat.", factor: "Melemahnya USD secara umum." },
        { monthYear: "Agu 2017", trend: "Uptrend", desc: "Kenaikan stabil.", factor: "Ketegangan geopolitik (Korea Utara & Venezuela)." },
        { monthYear: "Sep 2017", trend: "Downtrend", desc: "Koreksi yang signifikan.", factor: "The Fed mengumumkan pengurangan neraca." },
        { monthYear: "Okt 2017", trend: "Ranging", desc: "Fluktuasi kecil.", factor: "Menunggu kebijakan The Fed berikutnya." },
        { monthYear: "Nov 2017", trend: "Downtrend", desc: "Penurunan stabil.", factor: "Penguatan Dolar AS." },
        { monthYear: "Des 2017", trend: "Uptrend", desc: "Rally mini akhir tahun.", factor: "**The Fed menaikkan suku bunga (Rate Hike kelima).**" },
        // --- Periode 2018 (Perang Dagang & Kenaikan Suku Bunga) ---
        { monthYear: "Jan 2018", trend: "Uptrend", desc: "Bullish awal tahun, momentum kuat.", factor: "Kelemahan DXY & awal ketegangan perdagangan." },
        { monthYear: "Feb 2018", trend: "Downtrend", desc: "Koreksi tajam.", factor: "Kekuatan Dolar AS kembali." },
        { monthYear: "Mar 2018", trend: "Ranging", desc: "Sideways/konsolidasi.", factor: "**The Fed menaikkan suku bunga (Rate Hike keenam).**" },
        { monthYear: "Apr 2018", trend: "Downtrend", desc: "Tekanan jual dominan.", factor: "Imbal hasil obligasi AS naik." },
        { monthYear: "Mei 2018", trend: "Downtrend", desc: "Bearish berkelanjutan.", factor: "Penguatan Dolar AS karena Perang Dagang AS-Tiongkok." },
        { monthYear: "Jun 2018", trend: "Downtrend", desc: "Turun ke level terendah.", factor: "**The Fed menaikkan suku bunga (Rate Hike ketujuh).**" },
        { monthYear: "Jul 2018", trend: "Downtrend", desc: "Penurunan yang stabil.", factor: "Dolar AS sebagai safe haven." },
        { monthYear: "Agu 2018", trend: "Ranging", desc: "Mulai membentuk base di area bawah.", factor: "Investor mencerna kebijakan perdagangan AS." },
        { monthYear: "Sep 2018", trend: "Ranging", desc: "Volatilitas rendah.", factor: "Tidak ada katalis besar." },
        { monthYear: "Okt 2018", trend: "Uptrend", desc: "Rebound besar dari support.", factor: "Koreksi pasar saham global." },
        { monthYear: "Nov 2018", trend: "Ranging", desc: "Sideways di level tengah.", factor: "Menunggu pertemuan The Fed berikutnya." },
        { monthYear: "Des 2018", trend: "Uptrend kuat", desc: "Rally masif akhir tahun.", factor: "**The Fed menaikkan suku bunga (Rate Hike kedelapan) dan pasar saham AS anjlok.**" },
        // --- Periode 2019 (Fed Pivot Dovish) ---
        { monthYear: "Jan 2019", trend: "Ranging", desc: "Konsolidasi pasca rally besar.", factor: "The Fed bersikap dovish & mengisyaratkan pause rate hike." },
        { monthYear: "Feb 2019", trend: "Downtrend", desc: "Koreksi tajam.", factor: "Kekuatan Dolar AS sementara." },
        { monthYear: "Mar 2019", trend: "Ranging", desc: "Sideways, mencari arah.", factor: "Tidak ada data besar." },
        { monthYear: "Apr 2019", trend: "Ranging", desc: "Fluktuasi kecil.", factor: "Ketidakpastian negosiasi Brexit." },
        { monthYear: "Mei 2019", trend: "Ranging", desc: "Konsolidasi di area support.", factor: "Peningkatan ketegangan perdagangan AS-Tiongkok." },
        { monthYear: "Jun 2019", trend: "Uptrend tajam", desc: "Breakout kuat, momentum bullish.", factor: "The Fed mengisyaratkan pemotongan suku bunga (Rate Cut)." },
        { monthYear: "Jul 2019", trend: "Uptrend", desc: "Kenaikan stabil.", factor: "**The Fed memangkas suku bunga (Rate Cut pertama).**" },
        { monthYear: "Agu 2019", trend: "Uptrend kuat", desc: "Lonjakan besar menuju area 1550.", factor: "Ketegangan perdagangan AS-Tiongkok meningkat tajam." },
        { monthYear: "Sep 2019", trend: "Downtrend", desc: "Koreksi wajar pasca puncak.", factor: "**The Fed memangkas suku bunga (Rate Cut kedua).**" },
        { monthYear: "Okt 2019", trend: "Ranging", desc: "Sideways di level tinggi.", factor: "Mulai ada harapan damai dagang AS-Tiongkok." },
        { monthYear: "Nov 2019", trend: "Downtrend", desc: "Penurunan dari level tinggi.", factor: "**The Fed memangkas suku bunga (Rate Cut ketiga).**" },
        { monthYear: "Des 2019", trend: "Uptrend", desc: "Rally mini akhir tahun.", factor: "Ekspektasi inflasi, perjanjian damai dagang fase 1." },
        // --- Periode 2020 (Pandemi) hingga Okt 2025 ---
        { monthYear: "Jan 2020", trend: "Uptrend moderat", desc: "Emas menguat stabil sejak awal tahun.", factor: "Ketegangan ASâ€“Iran & penyebasan awal COVID-19 di Tiongkok." },
        { monthYear: "Feb 2020", trend: "Uptrend kuat", desc: "Harga melonjak tajam ke area 1.680â€“1.700.", factor: "COVID-19 mulai menyebar global, minat safe haven naik." },
        { monthYear: "Mar 2020", trend: "Volatil (Crash â†’ Rebound)", desc: "Awalnya turun drastis karena panic selling, lalu pulih.", factor: "Crash likuiditas global (Maret 2020), lalu intervensi The Fed." },
        { monthYear: "Apr 2020", trend: "Uptrend tajam", desc: "Rebound kuat menuju area 1.700â€“1750.", factor: "Stimulus besar-besaran & suku bunga mendekati 0%." },
        { monthYear: "Mei 2020", trend: "Uptrend stabil", desc: "Harga bertahan tinggi, permintaan investasi naik.", factor: "The Fed lanjutkan QE, inflasi jangka panjang diantisipasi." },
        { monthYear: "Jun 2020", trend: "Uptrend kuat", desc: "Breakout menuju area 1.780â€“1.800.", factor: "DXY melemah, ekspektasi stimulus tambahan." },
        { monthYear: "Jul 2020", trend: "Uptrend kuat", desc: "Lonjakan besar akibat stimulus pandemi global.", factor: "Stimulus masif dari The Fed & paket bantuan COVID-19." },
        { monthYear: "Agu 2020", trend: "Uptrend â†’ Koreksi", desc: "Mencapai puncak historis, lalu koreksi tajam.", factor: "Euforia safe haven puncak, lalu profit taking." },
        { monthYear: "Sep 2020", trend: "Downtrend", desc: "Tekanan jual pasca puncak Agustus.", factor: "Penguatan USD & ekspektasi pemulihan ekonomi." },
        { monthYear: "Okt 2020", trend: "Ranging", desc: "Konsolidasi di area 1880â€“1920.", factor: "Menunggu hasil pemilu AS 2020." },
        { monthYear: "Nov 2020", trend: "Downtrend", desc: "Penurunan akibat optimisme vaksin COVID-19.", factor: "Pengumuman vaksin Pfizer-BioNTech." },
        { monthYear: "Des 2020", trend: "Ranging â†’ Uptrend", desc: "Mulai pulih menjelang akhir tahun.", factor: "Paket stimulus tambahan AS disetujui." },
        { monthYear: "Jan 2021", trend: "Uptrend â†’ Downtrend", desc: "Lonjakan awal tahun, lalu terkoreksi.", factor: "Harapan stimulus Biden, lalu yield US naik." },
        { monthYear: "Feb 2021", trend: "Downtrend", desc: "Yield US naik, tekanan jual tinggi.", factor: "Lonjakan yield Treasury 10 tahun." },
        { monthYear: "Mar 2021", trend: "Ranging â†’ Downtrend", desc: "Volatilitas tinggi, gagal rebound.", factor: "Dolar menguat akibat ekspektasi tapering." },
        { monthYear: "Apr 2021", trend: "Ranging", desc: "Pasar mulai stabil di area bawah.", factor: "Tidak ada data besar; konsolidasi." },
        { monthYear: "Mei 2021", trend: "Uptrend kuat", desc: "Rebound besar dari area support.", factor: "Inflasi AS naik tajam â†’ dorong permintaan emas." },
        { monthYear: "Jun 2021", trend: "Downtrend tajam", desc: "Penurunan cepat pasca FOMC hawkish.", factor: "FOMC sinyalkan kenaikan suku bunga lebih cepat." },
        { monthYear: "Jul 2021", trend: "Ranging", desc: "Pergerakan datar, volatilitas rendah.", factor: "Pasar menunggu sinyal Fed berikutnya." },
        { monthYear: "Agu 2021", trend: "Ranging", desc: "Tidak ada arah jelas, harga berosilasi.", factor: "Data ekonomi campuran AS." },
        { monthYear: "Sep 2021", trend: "Downtrend", desc: "Tekanan jual dominan, lower low terbentuk.", factor: "Dolar menguat, ekspektasi tapering tinggi." },
        { monthYear: "Okt 2021", trend: "Uptrend", desc: "Reversal naik dari support bawah.", factor: "Inflasi tinggi picu minat safe haven." },
        { monthYear: "Nov 2021", trend: "Ranging", desc: "Konsolidasi di area tengah.", factor: "Menanti kepastian kebijakan tapering Fed." },
        { monthYear: "Des 2021", trend: "Ranging", desc: "Fluktuasi kecil menjelang akhir tahun.", factor: "Volume pasar rendah, libur akhir tahun." },
        { monthYear: "Jan 2022", trend: "Ranging â†’ Uptrend", desc: "Mulai muncul tekanan beli signifikan.", factor: "Ketegangan geopolitik Rusiaâ€“Ukraina meningkat." },
        { monthYear: "Feb 2022", trend: "Uptrend kuat", desc: "Lonjakan akibat geopolitik (Russiaâ€“Ukraine).", factor: "Invasi Rusia ke Ukraina (Feb 24)." },
        { monthYear: "Mar 2022", trend: "Downtrend tajam", desc: "Koreksi kuat pasca lonjakan ekstrem.", factor: "Ekspektasi kenaikan suku bunga Fed." },
        { monthYear: "Apr 2022", trend: "Ranging â†’ Downtrend", desc: "Harga gagal menembus resistance, berbalik turun.", factor: "The Fed mulai agresif (kebijakan hawkish)." },
        { monthYear: "Mei 2022", trend: "Downtrend", desc: "Bearish stabil dengan lower low.", factor: "Inflasi tinggi, Fed tingkatkan suku bunga." },
        { monthYear: "Jun 2022", trend: "Downtrend", desc: "Tekanan jual masih kuat.", factor: "USD terus menguat, DXY tembus 105." },
        { monthYear: "Jul 2022", trend: "Ranging", desc: "Konsolidasi membentuk base.", factor: "Ekspektasi inflasi mulai turun." },
        { monthYear: "Agu 2022", trend: "Uptrend singkat", desc: "Rebound teknikal dari support.", factor: "DXY melemah sementara." },
        { monthYear: "Sep 2022", trend: "Downtrend", desc: "Turun kembali setelah rally pendek.", factor: "Fed naikkan suku bunga 75 bps lagi." },
        { monthYear: "Okt 2022", trend: "Ranging", desc: "Area bottom mulai terbentuk.", factor: "Investor mulai akumulasi emas kembali." },
        { monthYear: "Nov 2022", trend: "Uptrend", desc: "Breakout resistance besar, momentum naik.", factor: "CPI AS turun â†’ ekspektasi Fed melunak." },
        { monthYear: "Des 2022", trend: "Uptrend", desc: "Tren naik stabil hingga akhir tahun.", factor: "Optimisme soft landing." },
        { monthYear: "Jan 2023", trend: "Uptrend", desc: "Higher high konsisten, tren bullish kuat.", factor: "DXY melemah, ekspektasi Fed akan pivot." },
        { monthYear: "Feb 2023", trend: "Downtrend", desc: "Koreksi dari puncak.", factor: "Data inflasi AS kembali tinggi." },
        { monthYear: "Mar 2023", trend: "Uptrend", desc: "Rebound kuat pasca koreksi.", factor: "Krisis perbankan AS (Silicon Valley Bank)." },
        { monthYear: "Apr 2023", trend: "Uptrend â†’ Ranging", desc: "Kenaikan melambat di resistance.", factor: "Fed jaga suku bunga tetap tinggi." },
        { monthYear: "Mei 2023", trend: "Downtrend", desc: "Tekanan jual mulai meningkat.", factor: "Debt ceiling AS & profit taking." },
        { monthYear: "Jun 2023", trend: "Ranging", desc: "Harga mendatar.", factor: "Tidak ada katalis besar." },
        { monthYear: "Jul 2023", trend: "Ranging", desc: "Volatilitas rendah.", factor: "Libur musim panas, volume tipis." },
        { monthYear: "Agu 2023", trend: "Ranging â†’ Uptrend awal", desc: "Mulai muncul higher low.", factor: "Data inflasi melunak." },
        { monthYear: "Sep 2023", trend: "Uptrend", desc: "Tren bullish stabil.", factor: "Fed sinyalkan akhir siklus kenaikan suku bunga." },
        { monthYear: "Okt 2023", trend: "Uptrend kuat", desc: "Breakout area resistance utama.", factor: "Konflik Hamasâ€“Israel (Okt 7)." },
        { monthYear: "Nov 2023", trend: "Uptrend", desc: "Momentum bullish masih dominan.", factor: "Ketegangan Timur Tengah berlanjut." },
        { monthYear: "Des 2023", trend: "Ranging", desc: "Konsolidasi di area puncak.", factor: "Pasar tenang jelang akhir tahun." },
        { monthYear: "Jan 2024", trend: "Ranging â†’ Downtrend", desc: "Awal tahun terjadi koreksi besar.", factor: "DXY rebound & data tenaga kerja kuat." },
        { monthYear: "Feb 2024", trend: "Downtrend", desc: "Penurunan konsisten, candle bearish besar.", factor: "CPI tinggi â†’ Fed hawkish kembali." },
        { monthYear: "Mar 2024", trend: "Ranging", desc: "Pasar tenang setelah koreksi.", factor: "Tidak ada data besar." },
        { monthYear: "Apr 2024", trend: "Uptrend kuat", desc: "Breakout dari konsolidasi, kenaikan signifikan.", factor: "Dolar melemah, data inflasi turun." },
        { monthYear: "Mei 2024", trend: "Uptrend", desc: "Tren naik masih terjaga.", factor: "Spekulasi pemotongan suku bunga Fed." },
        { monthYear: "Jun 2024", trend: "Ranging", desc: "Pergerakan mendatar di level tinggi.", factor: "Investor tunggu keputusan FOMC." },
        { monthYear: "Jul 2024", trend: "Downtrend", desc: "Koreksi dari area atas.", factor: "DXY menguat kembali." },
        { monthYear: "Aug 2024", trend: "Downtrend", desc: "Lanjutan tekanan jual.", factor: "PMI dan CPI positif di AS." },
        { monthYear: "Sep 2024", trend: "Ranging â†’ Uptrend", desc: "Reversal mulai terbentuk.", factor: "Ekspektasi dovish Fed." },
        { monthYear: "Okt 2024", trend: "Uptrend", desc: "Kenaikan stabil.", factor: "Inflasi global menurun." },
        { monthYear: "Nov 2024", trend: "Ranging", desc: "Konsolidasi di area atas.", factor: "Menunggu hasil pemilu AS." },
        { monthYear: "Des 2024", trend: "Uptrend", desc: "Bullish continuation menjelang akhir tahun.", factor: "Euforia pasca pemilu AS." },
        { monthYear: "Jan 2025", trend: "Uptrend", desc: "Harga menembus resistance lama.", factor: "Fed mulai potong suku bunga." },
        { monthYear: "Feb 2025", trend: "Ranging", desc: "Sideways di puncak.", factor: "Tidak ada katalis besar." },
        { monthYear: "Mar 2025", trend: "Downtrend", desc: "Koreksi wajar setelah rally panjang.", factor: "USD rebound teknikal." },
        { monthYear: "Apr 2025", trend: "Downtrend", desc: "Tekanan jual meningkat.", factor: "Data inflasi naik kembali." },
        { monthYear: "Mei 2025", trend: "Ranging", desc: "Konsolidasi setelah drop.", factor: "Pasar menunggu arah kebijakan baru Fed." },
        { monthYear: "Jun 2025", trend: "Ranging â†’ Uptrend", desc: "Tanda reversal bullish awal.", factor: "Data CPI menurun lagi." },
        { monthYear: "Jul 2025", trend: "Uptrend", desc: "Momentum naik mulai kuat lagi.", factor: "Spekulasi pemotongan lanjutan suku bunga." },
        { monthYear: "Agu 2025", trend: "Uptrend", desc: "Bullish stabil dengan higher low.", factor: "USD melemah, risk-off meningkat." },
        { monthYear: "Sep 2025", trend: "Ranging", desc: "Mulai datar menjelang Q4.", factor: "Tidak ada event besar." },
        { monthYear: "Okt 2025", trend: "Ranging â†’ Uptrend", desc: "Ada potensi kenaikan lanjutan ke akhir tahun.", factor: "Ketegangan geopolitik baru di Timur Tengah." }
    ];

    const priceData = [
        // --- Periode 2015 ---
        { month: 'Jan', year: 2015, high: 1307.387, low: 1201.766 },
        { month: 'Feb', year: 2015, high: 1295.277, low: 1195.424 },
        { month: 'Mar', year: 2015, high: 1224.239, low: 1142.345 },
        { month: 'Apr', year: 2015, high: 1224.591, low: 1178.614 },
        { month: 'Mei', year: 2015, high: 1232.067, low: 1170.925 },
        { month: 'Jun', year: 2015, high: 1204.31, low: 1172.935 },
        { month: 'Jul', year: 2015, high: 1165.738, low: 1076.62 },
        { month: 'Agu', year: 2015, high: 1131.742, low: 1079.176 },
        { month: 'Sep', year: 2015, high: 1156.401, low: 1104.997 },
        { month: 'Okt', year: 2015, high: 1184.225, low: 1100.868 },
        { month: 'Nov', year: 2015, high: 1150.311, low: 1064.954 },
        { month: 'Des', year: 2015, high: 1087.97, low: 1046.208 },
        // --- Periode 2016 ---
        { month: 'Jan', year: 2016, high: 1127.915, low: 1070.781 },
        { month: 'Feb', year: 2016, high: 1263.951, low: 1092.793 },
        { month: 'Mar', year: 2016, high: 1284.156, low: 1206.197 },
        { month: 'Apr', year: 2016, high: 1297.042, low: 1210.027 },
        { month: 'Mei', year: 2016, high: 1300.732, low: 1209.615 },
        { month: 'Jun', year: 2016, high: 1358.97, low: 1201.037 },
        { month: 'Jul', year: 2016, high: 1375.02, low: 1308.205 },
        { month: 'Agu', year: 2016, high: 1367.62, low: 1310.875 },
        { month: 'Sep', year: 2016, high: 1343.344, low: 1302.26 },
        { month: 'Okt', year: 2016, high: 1337.894, low: 1241.055 },
        { month: 'Nov', year: 2016, high: 1304.538, low: 1170.999 },
        { month: 'Des', year: 2016, high: 1180.767, low: 1121.282 },
        // --- Periode 2017 ---
        { month: 'Jan', year: 2017, high: 1221.782, low: 1139.75 },
        { month: 'Feb', year: 2017, high: 1263.268, low: 1209.083 },
        { month: 'Mar', year: 2017, high: 1269.467, low: 1205.578 },
        { month: 'Apr', year: 2017, high: 1295.631, low: 1239.544 },
        { month: 'Mei', year: 2017, high: 1272.76, low: 1214.39 },
        { month: 'Jun', year: 2017, high: 1295.731, low: 1230.134 },
        { month: 'Jul', year: 2017, high: 1264.44, low: 1204.654 },
        { month: 'Agu', year: 2017, high: 1317.02, low: 1251.107 },
        { month: 'Sep', year: 2017, high: 1357.755, low: 1260.675 },
        { month: 'Okt', year: 2017, high: 1306.075, low: 1260.368 },
        { month: 'Nov', year: 2017, high: 1296.38, low: 1263.743 },
        { month: 'Des', year: 2017, high: 1299.165, low: 1236.787 },
        // --- Periode 2018 ---
        { month: 'Jan', year: 2018, high: 1366.195, low: 1308.267 },
        { month: 'Feb', year: 2018, high: 1361.642, low: 1307.747 },
        { month: 'Mar', year: 2018, high: 1357.877, low: 1305.105 },
        { month: 'Apr', year: 2018, high: 1365.17, low: 1304.57 },
        { month: 'Mei', year: 2018, high: 1324.966, low: 1284.116 },
        { month: 'Jun', year: 2018, high: 1309.847, low: 1243.618 },
        { month: 'Jul', year: 2018, high: 1265.918, low: 1211.961 },
        { month: 'Agu', year: 2018, high: 1220.738, low: 1160.038 },
        { month: 'Sep', year: 2018, high: 1215.111, low: 1184.148 },
        { month: 'Okt', year: 2018, high: 1243.518, low: 1183.05 },
        { month: 'Nov', year: 2018, high: 1249.773, low: 1200.738 },
        { month: 'Des', year: 2018, high: 1285.498, low: 1219.866 },
        // --- Periode 2019 ---
        { month: 'Jan', year: 2019, high: 1317.844, low: 1276.104 },
        { month: 'Feb', year: 2019, high: 1346.746, low: 1280.975 },
        { month: 'Mar', year: 2019, high: 1324.464, low: 1281.332 },
        { month: 'Apr', year: 2019, high: 1310.279, low: 1266.386 },
        { month: 'Mei', year: 2019, high: 1303.407, low: 1266.696 },
        { month: 'Jun', year: 2019, high: 1441.761, low: 1270.751 },
        { month: 'Jul', year: 2019, high: 1453.076, low: 1381.821 },
        { month: 'Agu', year: 2019, high: 1555.708, low: 1451.916 },
        { month: 'Sep', year: 2019, high: 1557.067, low: 1459.186 },
        { month: 'Okt', year: 2019, high: 1519.814, low: 1457.551 },
        { month: 'Nov', year: 2019, high: 1514.88, low: 1445.672 },
        { month: 'Des', year: 2019, high: 1525.185, low: 1458.556 },
        // --- Periode 2020 - Okt 2025 (Verifikasi data Anda) ---
        { month: 'Jan', year: 2020, high: 1611.365, low: 1517.172 },
        { month: 'Feb', year: 2020, high: 1689.213, low: 1547.479 },
        { month: 'Mar', year: 2020, high: 1703.179, low: 1451.281 },
        { month: 'Apr', year: 2020, high: 1746.579, low: 1571.348 },
        { month: 'Mei', year: 2020, high: 1764.715, low: 1670.131 },
        { month: 'Jun', year: 2020, high: 1785.729, low: 1670.51 },
        { month: 'Jul', year: 2020, high: 1982.318, low: 1757.464 },
        { month: 'Agu', year: 2020, high: 2073.682, low: 1863.593 },
        { month: 'Sep', year: 2020, high: 1992.297, low: 1848.076 },
        { month: 'Okt', year: 2020, high: 1933.178, low: 1859.815 },
        { month: 'Nov', year: 2020, high: 1965.419, low: 1764.16 },
        { month: 'Des', year: 2020, high: 1906.667, low: 1776.74 },
        { month: 'Jan', year: 2021, high: 1959.29, low: 1802.438 },
        { month: 'Feb', year: 2021, high: 1871.716, low: 1717.03 },
        { month: 'Mar', year: 2021, high: 1759.715, low: 1676.627 },
        { month: 'Apr', year: 2021, high: 1797.756, low: 1705.761 },
        { month: 'Mei', year: 2021, high: 1912.616, low: 1766.046 },
        { month: 'Jun', year: 2021, high: 1916.446, low: 1750.621 },
        { month: 'Jul', year: 2021, high: 1834.039, low: 1765.633 },
        { month: 'Agu', year: 2021, high: 1831.657, low: 1686.784 },
        { month: 'Sep', year: 2021, high: 1833.859, low: 1721.571 },
        { month: 'Okt', year: 2021, high: 1813.56, low: 1745.822 },
        { month: 'Nov', year: 2021, high: 1877.067, low: 1758.534 },
        { month: 'Des', year: 2021, high: 1828.722, low: 1753.053 },
        { month: 'Jan', year: 2022, high: 1853.785, low: 1779.895 },
        { month: 'Feb', year: 2022, high: 1974.331, low: 1788.521 },
        { month: 'Mar', year: 2022, high: 2070.292, low: 1889.783 },
        { month: 'Apr', year: 2022, high: 1998.024, low: 1871.981 },
        { month: 'Mei', year: 2022, high: 1909.551, low: 1786.381 },
        { month: 'Jun', year: 2022, high: 1878.832, low: 1802.627 },
        { month: 'Jul', year: 2022, high: 1814.091, low: 1680.811 },
        { month: 'Agu', year: 2022, high: 1807.831, low: 1705.48 },
        { month: 'Sep', year: 2022, high: 1735.081, low: 1614.427 },
        { month: 'Okt', year: 2022, high: 1729.469, low: 1616.886 },
        { month: 'Nov', year: 2022, high: 1786.472, low: 1616.624 },
        { month: 'Des', year: 2022, high: 1832.979, low: 1765.756 },
        { month: 'Jan', year: 2023, high: 1949.116, low: 1823.998 },
        { month: 'Feb', year: 2023, high: 1959.639, low: 1804.362 },
        { month: 'Mar', year: 2023, high: 2009.668, low: 1809.372 },
        { month: 'Apr', year: 2023, high: 2048.597, low: 1949.542 },
        { month: 'Mei', year: 2023, high: 2079.817, low: 1932.042 },
        { month: 'Jun', year: 2023, high: 1983.332, low: 1892.839 },
        { month: 'Jul', year: 2023, high: 1987.421, low: 1902.568 },
        { month: 'Agu', year: 2023, high: 1964.628, low: 1884.547 },
        { month: 'Sep', year: 2023, high: 1952.331, low: 1846.282 },
        { month: 'Okt', year: 2023, high: 2009.327, low: 1810.402 },
        { month: 'Nov', year: 2023, high: 2052.03, low: 1921.394 },
        { month: 'Des', year: 2023, high: 2144.46, low: 1973.033 },
        { month: 'Jan', year: 2024, high: 2078.877, low: 2001.742 },
        { month: 'Feb', year: 2024, high: 2065.458, low: 1984.121 },
        { month: 'Mar', year: 2024, high: 2247.34, low: 2039.039 },
        { month: 'Apr', year: 2024, high: 2431.527, low: 2228.472 },
        { month: 'Mei', year: 2024, high: 2450.026, low: 2277.089 },
        { month: 'Jun', year: 2024, high: 2387.702, low: 2286.723 },
        { month: 'Jul', year: 2024, high: 2483.739, low: 2318.438 },
        { month: 'Agu', year: 2024, high: 2531.668, low: 2364.267 },
        { month: 'Sep', year: 2024, high: 2685.611, low: 2471.826 },
        { month: 'Okt', year: 2024, high: 2790.075, low: 2602.178 },
        { month: 'Nov', year: 2024, high: 2762.254, low: 2536.755 },
        { month: 'Des', year: 2024, high: 2726.206, low: 2583.389 },
        { month: 'Jan', year: 2025, high: 2817.244, low: 2614.419 },
        { month: 'Feb', year: 2025, high: 2956.229, low: 2772.151 },
        { month: 'Mar', year: 2025, high: 3128.165, low: 2858.83 },
        { month: 'Apr', year: 2025, high: 3500.033, low: 2956.374 },
        { month: 'Mei', year: 2025, high: 3435.016, low: 3120.65 },
        { month: 'Jun', year: 2025, high: 3451.251, low: 3247.921 },
        { month: 'Jul', year: 2025, high: 3438.98, low: 3268.034 },
        { month: 'Agu', year: 2025, high: 3453.924, low: 3281.566 },
        { month: 'Sep', year: 2025, high: 3871.7, low: 3437.028 },
        { month: 'Okt', year: 2025, high: 4380.074, low: 3819.335 }
    ];
</script>

<header class="w-full bg-gray-900/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-800">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <h1 class="text-2xl font-bold text-emerald-400">Market<span class="text-slate-100">AI</span> Dashboard</h1>
            <nav class="hidden md:flex space-x-4 text-sm font-medium">
                <a href="#dashboard" class="text-slate-400 hover:text-emerald-400 transition">Dashboard</a>
                <a href="#context" class="text-slate-400 hover:text-emerald-400 transition">Context</a>
                <a href="#data-historis" class="text-slate-400 hover:text-emerald-400 transition">Data Historis</a>
            </nav>
        </div>
        <div class="flex items-center space-x-4">
            <div class="relative">
                <select id="symbolSelect" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5">
                    <option value="XAUUSD">XAU/USD (Gold)</option>
                    <option value="EURUSD">EUR/USD (Euro)</option>
                    <option value="USDJPY">USD/JPY (Yen)</option>
                    <option value="SPX500">S&P 500</option>
                    <option value="BTCUSD">BTC/USD (Bitcoin)</option>
                </select>
            </div>
            <span class="text-sm font-medium text-gray-400">by Gemini</span>
        </div>
    </div>
</header>

<main class="max-w-[1400px] mx-auto px-4 py-6 layout-grid-new">
    <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl h-[500px] lg:h-[700px]">
        <h2 class="text-lg font-bold text-slate-100 mb-2">Technical Analysis Chart</h2>
        <div class="tradingview-widget-container h-[95%]">
            <div id="tradingview_main_chart" class="tradingview-widget-container__widget h-full"></div>
            </div>
    </div>

    <div class="space-y-6">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl h-fit">
            <div class="flex border-b border-gray-800 mb-4">
                <button id="tabHeatmap" class="py-2 px-4 text-sm font-medium border-b-2 border-emerald-500 text-emerald-400 transition-colors duration-200">Forex Heatmap</button>
                <button id="tabScreener" class="py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:border-gray-600 hover:text-slate-200 transition-colors duration-200">Stock Screener</button>
            </div>
            
            <div id="contentHeatmap" class="tab-content h-[280px]">
                <div class="tradingview-widget-container h-full">
                    <div id="tradingview_heatmap" class="tradingview-widget-container__widget h-full"></div>
                </div>
            </div>

            <div id="contentScreener" class="tab-content h-[280px] hidden">
                <div class="tradingview-widget-container h-full">
                    <div id="tradingview_screener" class="tradingview-widget-container__widget h-full"></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl h-fit">
            <h2 class="text-lg font-bold text-slate-100 mb-2">Economic Calendar</h2>
            <div class="tradingview-widget-container h-[300px]">
                <div id="tradingview_calendar_compact" class="tradingview-widget-container__widget h-full"></div>
            </div>
        </div>
    </div>

    <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl h-[700px] overflow-hidden">
        <h2 class="text-lg font-bold text-slate-100 mb-2">Global Financial News</h2>
        <div class="tradingview-widget-container h-[95%]">
            <div id="tradingview_news_feed" class="tradingview-widget-container__widget h-full"></div>
        </div>
    </div>
</main>

<section id="context" class="max-w-[1400px] mx-auto px-4 pb-12 mt-6">
    <h2 class="text-2xl font-bold text-slate-100 mb-6 border-b border-gray-800 pb-2">Global Market Context</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl">
            <h3 class="text-lg font-bold text-slate-100 mb-2">Earnings Calendar Timeline</h3>
            <div class="tradingview-widget-container h-[350px]">
                <div id="tradingview_earnings_timeline" class="tradingview-widget-container__widget h-full"></div>
            </div>
        </div>

        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl">
            <h3 class="text-lg font-bold text-slate-100 mb-2">Forex Cross Rates</h3>
            <div class="tradingview-widget-container h-[350px]">
                <div id="tradingview_forex_rates" class="tradingview-widget-container__widget h-full"></div>
            </div>
        </div>
    </div>
</section>

<section id="data-historis" class="max-w-[1400px] mx-auto px-4 pb-12 mt-6">
    <h2 class="text-2xl font-bold text-emerald-400 mb-6 border-b border-gray-800 pb-2">Historical Data: XAU/USD (2015-2025)</h2>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl">
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-lg font-bold text-slate-200">Historical Price Line Chart (Harga Penutupan Rata-rata)</h4>
                <div class="flex gap-2">
                    <select id="yearSelect" class="bg-gray-700 text-white text-sm rounded-lg p-1.5 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="all">Keseluruhan (2015-2025)</option>
                        </select>
                </div>
            </div>
            <div class="h-[400px] relative">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 shadow-xl">
            <h4 class="text-lg font-bold text-slate-200 mb-3">Historical Trend and Factor Analysis</h4>
            <div class="h-[400px] overflow-y-auto custom-scroll">
                <table id="dataTable" class="min-w-full divide-y divide-gray-700 text-sm">
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/5">Periode</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/5">Tren</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-3/5">Faktor Pendorong</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800" id="tableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
<button id="chatFab" aria-label="Open AI chat" class="fixed right-6 bottom-6 w-12 h-12 rounded-full shadow-2xl bg-emerald-600 hover:bg-emerald-500 text-black flex items-center justify-center text-md font-bold transition duration-300 transform hover:scale-105 z-[900]">
    AI
</button>

<div id="chatModal" class="fixed inset-0 bg-gray-950 bg-opacity-80 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
    <div class="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md h-[80vh] flex flex-col border border-gray-800">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <h3 class="text-xl font-bold text-emerald-400">Gemini Market AI Chat</h3>
            <button id="closeModalBtn" class="text-gray-400 hover:text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="chatWindow" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scroll">
            <div class="flex justify-start">
                <div class="bg-gray-800 p-3 rounded-lg max-w-[80%] shadow-md">
                    <p class="text-sm text-slate-200">Halo! Saya adalah AI Asisten Pasar Keuangan yang ditenagai oleh Gemini. Tanyakan apa saja mengenai data di dashboard ini, analisis teknikal, atau event ekonomi global. ðŸš€</p>
                </div>
            </div>
        </div>
        <div class="p-4 border-t border-gray-800 flex items-end">
            <label for="imageInput" class="cursor-pointer p-2 rounded-full text-gray-400 hover:bg-gray-700 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
            </label>
            <input type="file" id="imageInput" accept="image/*" class="hidden">

            <textarea id="messageInput" rows="1" placeholder="Ketik pesan atau unggah chart..." class="flex-grow mx-2 p-3 text-sm bg-gray-800 border border-gray-700 rounded-xl resize-none focus:ring-emerald-500 focus:border-emerald-500 text-white custom-scroll"></textarea>
            <button id="sendBtn" class="p-3 bg-emerald-600 rounded-full text-white hover:bg-emerald-500 disabled:bg-gray-600 disabled:text-gray-400 transition" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
            </button>
        </div>
    </div>
</div>

<script>
    /* ========================================================================================= */
    /* ======== LOGIKA UTAMA: TradingView Widgets, Tabs, dan Chat AI ======== */
    /* ========================================================================================= */

    // 1. Inisialisasi TradingView
    const symbolSelect = document.getElementById('symbolSelect');
    let currentSymbol = symbolSelect.value;
    
    function loadTradingViewWidgets(symbol) {
        // Hapus widget lama
        document.getElementById('tradingview_main_chart').innerHTML = '';
        document.getElementById('tradingview_heatmap').innerHTML = '';
        document.getElementById('tradingview_screener').innerHTML = '';
        document.getElementById('tradingview_calendar_compact').innerHTML = '';
        document.getElementById('tradingview_news_feed').innerHTML = '';
        document.getElementById('tradingview_earnings_timeline').innerHTML = '';
        document.getElementById('tradingview_forex_rates').innerHTML = '';

        // Chart Utama
        new TradingView.widget({
            "container_id": "tradingview_main_chart",
            "symbol": symbol,
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "withdateranges": true,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "details": true,
            "hotlist": true,
            "studies": ["RSI@tv-basicstudies", "MASimple@tv-basicstudies"],
            "support_host": "https://www.tradingview.com"
        });

        // Forex Heatmap
        new TradingView.widget({
            "container_id": "tradingview_heatmap",
            "width": "100%",
            "height": "100%",
            "style": "heatmap",
            "locale": "en",
            "largeChartUrl": "",
            "plotGradient": true,
            "timeFrame": "12M",
            "scalePosition": "no",
            "borderColor": "rgba(255, 255, 255, 0.05)",
            "colorTheme": "dark",
            "is</script> ...
            "symbol": "FX:EURUSD", "column": "change", "row": "value", "column_sort_order": "desc"
        });

        // Stock Screener (default: US stocks)
        new TradingView.widget({
            "container_id": "tradingview_screener",
            "width": "100%",
            "height": "100%",
            "style": "1",
            "locale": "en",
            "screenMode": "desktop",
            "colorTheme": "dark",
            "defaultColumn": "overview",
            "market": "america",
            "showToolbar": false,
            "symbols": [
                { "s": "NASDAQ:TSLA", "d": "Tesla" },
                { "s": "NASDAQ:AAPL", "d": "Apple" },
                { "s": "NASDAQ:NVDA", "d": "NVIDIA" },
                { "s": "NASDAQ:GOOGL", "d": "Alphabet Inc. Class A" },
                { "s": "NASDAQ:MSFT", "d": "Microsoft" }
            ]
        });

        // Economic Calendar Compact
        new TradingView.widget({
            "container_id": "tradingview_calendar_compact",
            "width": "100%",
            "height": "100%",
            "colorTheme": "dark",
            "locale": "en",
            "is=" : "compact",
            "importanceFilter": "-1,0,1"
        });

        // Global News Feed
        new TradingView.widget({
            "container_id": "tradingview_news_feed",
            "width": "100%",
            "height": "100%",
            "feedMode": "all_news",
            "colorTheme": "dark",
            "locale": "en",
            "news": ["stock", "forex", "crypto"],
            "showMenu": false,
            "allowAutoScroll": true
        });

        // Earnings Calendar Timeline
        new TradingView.widget({
            "container_id": "tradingview_earnings_timeline",
            "width": "100%",
            "height": "100%",
            "colorTheme": "dark",
            "locale": "en",
            "is=" : "earnings_calendar_timeline"
        });
        
        // Forex Cross Rates
        new TradingView.widget({
            "container_id": "tradingview_forex_rates",
            "width": "100%",
            "height": "100%",
            "colorTheme": "dark",
            "locale": "en",
            "is=" : "forex_cross_rates",
            "currencies": ["EUR", "USD", "JPY", "GBP", "AUD", "CAD", "CHF"],
            "columns": ["log", "change", "bid", "ask"],
            "lastModified": "2024-05-20T00:00:00.000Z"
        });
    }

    // Panggil saat symbol berubah
    symbolSelect.addEventListener('change', (e) => {
        currentSymbol = e.target.value;
        loadTradingViewWidgets(currentSymbol);
    });

    // Panggil saat window load
    window.addEventListener('load', () => {
        // TradingView Widgets
        loadTradingViewWidgets(currentSymbol);
    });


    // 2. Logika Tabs (Heatmap/Screener)
    const tabHeatmap = document.getElementById('tabHeatmap');
    const tabScreener = document.getElementById('tabScreener');
    const contentHeatmap = document.getElementById('contentHeatmap');
    const contentScreener = document.getElementById('contentScreener');

    function switchTab(activeTab) {
        if (activeTab === 'heatmap') {
            tabHeatmap.classList.add('border-emerald-500', 'text-emerald-400');
            tabHeatmap.classList.remove('border-transparent', 'text-gray-400', 'hover:border-gray-600', 'hover:text-slate-200');
            tabScreener.classList.remove('border-emerald-500', 'text-emerald-400');
            tabScreener.classList.add('border-transparent', 'text-gray-400', 'hover:border-gray-600', 'hover:text-slate-200');
            
            contentHeatmap.classList.remove('hidden');
            contentScreener.classList.add('hidden');
        } else {
            tabScreener.classList.add('border-emerald-500', 'text-emerald-400');
            tabScreener.classList.remove('border-transparent', 'text-gray-400', 'hover:border-gray-600', 'hover:text-slate-200');
            tabHeatmap.classList.remove('border-emerald-500', 'text-emerald-400');
            tabHeatmap.classList.add('border-transparent', 'text-gray-400', 'hover:border-gray-600', 'hover:text-slate-200');

            contentScreener.classList.remove('hidden');
            contentHeatmap.classList.add('hidden');
        }
    }

    tabHeatmap.addEventListener('click', () => switchTab('heatmap'));
    tabScreener.addEventListener('click', () => switchTab('screener'));
    
    
    // 3. Logika Chat Modal dan API Gemini
    const chatFab = document.getElementById('chatFab');
    const chatModal = document.getElementById('chatModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const chatWindow = document.getElementById('chatWindow');
    const messageInput = document.getElementById('messageInput');
    const imageInput = document.getElementById('imageInput');
    const sendBtn = document.getElementById('sendBtn');

    chatFab.addEventListener('click', () => chatModal.classList.remove('hidden'));
    closeModalBtn.addEventListener('click', () => chatModal.classList.add('hidden'));

    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
        sendBtn.disabled = messageInput.value.trim() === '';
    });
    
    function appendMsg(sender, content, hasImage = false) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
        
        let contentHtml = '';
        if (typeof content === 'string') {
            contentHtml = `<p class="text-sm text-slate-200">${content}</p>`;
        } else if (hasImage) {
            contentHtml = `
                ${content.fileName ? `<p class="text-xs text-gray-400 mb-2 italic">${content.fileName}</p>` : ''}
                <img src="${content.imagePreview}" alt="Chart Preview" class="max-w-full h-auto rounded-lg mb-2 border border-gray-700">
                <p class="text-sm text-slate-200">${content.text || 'Menganalisis gambar...'}</p>
            `;
        }

        msgDiv.innerHTML = `
            <div class="${sender === 'user' ? 'bg-emerald-600 text-white' : 'bg-gray-800 text-slate-200'} p-3 rounded-xl max-w-[80%] shadow-lg">
                ${contentHtml}
            </div>
        `;
        chatWindow.appendChild(msgDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showLoading() {
        sendBtn.disabled = true;
        messageInput.disabled = true;
        imageInput.disabled = true;

        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.className = 'flex justify-start';
        loadingDiv.innerHTML = `
            <div class="bg-gray-800 p-3 rounded-xl max-w-[80%] shadow-md">
                <div class="flex items-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-emerald-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-sm text-slate-200">AI sedang mengetik...</span>
                </div>
            </div>
        `;
        chatWindow.appendChild(loadingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loadingIndicator');
        if (loadingDiv) loadingDiv.remove();
        
        sendBtn.disabled = messageInput.value.trim() === '';
        messageInput.disabled = false;
        imageInput.disabled = false;
    }

    async function fileToGenerativePart(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64Data = reader.result.split(',')[1];
                resolve({
                    inlineData: {
                        data: base64Data,
                        mimeType: file.type
                    }
                });
            };
            reader.onerror = error => reject(error);
            reader.readAsDataURL(file);
        });
    }

    async function callGemini(parts, type) {
        showLoading();
        
        const systemInstruction = `Anda adalah asisten AI profesional untuk Analisis Pasar Keuangan. Jawab semua pertanyaan dengan ringkas dan informatif, fokus pada data yang relevan (misalnya, data historis XAU/USD, event kalender, atau analisis teknikal chart yang diunggah). Selalu gunakan bahasa Indonesia.`;
        
        const requestBody = {
            contents: [{
                parts: parts
            }],
            config: {
                systemInstruction: systemInstruction,
            }
        };

        try {
            const response = await fetch(`${GEMINI_API_URL}/${type === 'text' ? TEXT_MODEL : MULTIMODAL_MODEL}:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Gemini API Error: ${error.error.message}`);
            }

            const data = await response.json();
            const text = data.candidates[0]?.content?.parts[0]?.text || "Maaf, saya tidak dapat memproses permintaan ini. Coba lagi.";
            appendMsg('bot', text);

        } catch (error) {
            console.error(error);
            appendMsg('bot', `<span class="text-red-400 font-semibold">âŒ Error: ${error.message}</span>`);
        } finally {
            hideLoading();
        }
    }
    
    function handleSend() {
        const message = messageInput.value.trim();
        if (message === '') return;

        appendMsg('user', message); 
        messageInput.value = '';

        const bodyParts = [{ text: message }];

        callGemini(bodyParts, 'text');
    }

    async function handleImageFileChange() {
        const file = imageInput.files[0];
        const message = messageInput.value.trim();
        
        if (!file) return;

        const imagePreview = URL.createObjectURL(file);
        appendMsg('user', { imagePreview, fileName: file.name }, true);
        
        try {
             var imagePart = await fileToGenerativePart(file);
        } catch (error) {
             appendMsg('bot', `<span class="text-red-400 font-semibold">âŒ Error saat membaca file: ${error.message}</span>`);
             imageInput.value = ''; 
             return;
        }

        const bodyParts = [imagePart];
        if (message) {
            bodyParts.push({ text: message });
        } else {
            bodyParts.push({ text: "Analisis gambar chart ini." });
        }

        messageInput.value = '';
        imageInput.value = ''; 

        callGemini(bodyParts, 'multimodal');
    }


    /* ======== Event Listeners yang Diperbarui ======== */

    sendBtn.addEventListener('click', handleSend);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !messageInput.disabled) handleSend();
    });

    imageInput.addEventListener('change', handleImageFileChange);


    /* ========================================================================================= */
    /* ======== ðŸ’¡ LOGIKA BARU: CHART & TABEL DATA LOKAL ======== */
    /* ========================================================================================= */

    // 1. Inisialisasi Chart
    let priceChart; 
    const yearSelect = document.getElementById('yearSelect');
    
    // Fungsi untuk mendapatkan warna berdasarkan trend
    function getTrendColor(trend) {
        if (trend.includes('Uptrend') || trend.includes('Bullish')) return 'text-green-400';
        if (trend.includes('Downtrend') || trend.includes('Bearish')) return 'text-red-400';
        return 'text-yellow-400'; // Ranging/Volatil
    }
    
    // Fungsi untuk mengisi tabel
    function populateTable(data) {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = ''; // Kosongkan tabel
        
        data.forEach(item => {
            const row = tableBody.insertRow();
            const trendColor = getTrendColor(item.trend);
            
            row.className = 'hover:bg-gray-800 transition duration-150';

            row.innerHTML = `
                <td class="px-3 py-2 whitespace-nowrap text-xs font-medium text-gray-400">${item.monthYear}</td>
                <td class="px-3 py-2 whitespace-nowrap text-xs font-semibold ${trendColor}">${item.trend}</td>
                <td class="px-3 py-2 text-xs text-gray-400">${item.factor}</td>
            `;
        });
    }
    
    // Fungsi untuk memfilter data dan memperbarui chart
    function updateChart(selectedYear) {
        let filteredPriceData = priceData;
        let filteredRawData = rawData;
        
        if (selectedYear !== 'all') {
            const year = parseInt(selectedYear);
            filteredPriceData = priceData.filter(d => d.year === year);
            filteredRawData = rawData.filter(d => d.monthYear.includes(selectedYear));
        }

        // Hitung harga penutupan rata-rata (mid-price) untuk chart
        const labels = filteredPriceData.map(d => `${d.month} ${d.year}`);
        const midPrices = filteredPriceData.map(d => (d.high + d.low) / 2);
        
        // Perbarui data tabel
        populateTable(filteredRawData);

        // Hancurkan chart lama jika ada
        if (priceChart) {
            priceChart.destroy();
        }

        // Buat chart baru
        const ctx = document.getElementById('priceChart').getContext('2d');
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Harga Penutupan Rata-rata (Mid-Price)',
                    data: midPrices,
                    borderColor: '#10B981', // emerald-500
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: '#10B981',
                    fill: false,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#1F2937', // gray-800
                        titleColor: '#E5E7EB', // slate-200
                        bodyColor: '#D1D5DB' // gray-400
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: { display: false },
                        ticks: {
                            color: '#6B7280', // gray-400
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Harga (USD)',
                            color: '#9CA3AF'
                        },
                        ticks: { color: '#6B7280' },
                        grid: { color: 'rgba(255, 255, 255, 0.05)' }
                    }
                }
            }
        });
    }

    // Fungsi inisialisasi awal
    function initLocalDataWidgets() {
        // Isi opsi tahun di Select
        const years = [...new Set(priceData.map(d => d.year))].sort((a, b) => b - a);
        years.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        });
        
        // Event listener untuk perubahan tahun
        yearSelect.addEventListener('change', (e) => {
            updateChart(e.target.value);
        });

        // Tampilkan data default (Keseluruhan)
        updateChart('all');
    }

    // Jalankan inisialisasi setelah DOM dimuat
    window.addEventListener('load', initLocalDataWidgets);

    // ======== AKHIR LOGIKA BARU ========

</script>
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</body>
</html>
