<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAU/USD Trading Dashboard - Analisis Historis & Gemini AI</title>
    <!-- Tailwind CSS (Aesthetics and utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap 5 (for simple layout components) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js (for visualizations) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
    <!-- Chart.js Datalabels Plugin (optional, for bar chart labels) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Font Awesome (for icons and loading spinner) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJg1zJvJvF8t8m8oGf4t7I3b5gL6R8t5gW0p4O3F9t3/l8E6i/w4lQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Menggunakan font Inter secara default */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .heatmap-cell {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .heatmap-cell:hover { transform: scale(1.05); z-index: 10; }
        .bg-red-custom { background-color: #dc3545; color: white; }
        .bg-yellow-custom { background-color: #ffc107; color: black; }
        .bg-green-custom { background-color: #198754; color: white; }
        .bg-gray-custom { background-color: #e9ecef; color: #6c757d; }
        /* Style untuk pre-formatted AI response */
        #newsResult {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 1rem;
            background-color: #1e293b; /* Darker background for console/code feel */
            color: #e2e8f0;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: monospace;
            line-height: 1.5;
        }
        .btn-primary { background-color: #1e3a8a; border-color: #1e3a8a; }
        .btn-primary:hover { background-color: #172554; border-color: #172554; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-6 pb-4 border-b border-gray-300">
        <h1 class="text-3xl font-bold text-gray-800">ðŸ“Š XAU/USD Historical & AI Dashboard</h1>
        <p class="text-gray-600">Analisis Pergerakan Harga Emas (XAU/USD) Berdasarkan Data Statis 2020-2025</p>
    </header>

    <!-- Section 1: Gemini AI Terminal -->
    <section class="mb-8 p-4 md:p-6 bg-white card">
        <h2 class="text-xl font-semibold mb-3 text-gray-800 flex items-center">
            <i class="fas fa-brain mr-2 text-indigo-600"></i> Gemini AI Terminal (Analisis Data Lokal)
        </h2>
        <p class="text-sm text-gray-600 mb-4">Masukkan kueri untuk menganalisis data historis (Heatmap/Tabel) di bawah. Analisis ini **tidak** menggunakan data pasar real-time.</p>
        
        <div class="input-group mb-3">
            <input type="text" id="newsQuery" class="form-control rounded-l-lg p-3 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: 'Apa faktor pemicu utama kenaikan di Q3?' atau 'Bagaimana tren harga di bulan Januari?'" aria-label="Analisis Query">
            <button class="btn btn-primary px-4 rounded-r-lg" type="button" id="searchNewsBtn">
                <i class="fas fa-search"></i> Cek Analisis
            </button>
        </div>

        <!-- Status Loading -->
        <div id="searchStatus" class="alert alert-info py-2 px-3 mb-3 text-sm" style="display:none;">
            <i class="fas fa-spinner fa-spin"></i> **[STATUS]** Mengirim kueri ke Google Gemini...
        </div>

        <!-- Hasil Analisis -->
        <pre id="newsResult" class="text-sm">
[CONSOLE] Menunggu input kueri. Panggilan API aman melalui Vercel Serverless Function.
        </pre>
    </section>

    <!-- Section 2: Visualisasi (Heatmap, Bar Chart, Line Chart) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        
        <!-- Heatmap Pergerakan Bulanan -->
        <div class="col-span-1 lg:col-span-1 p-4 md:p-6 bg-white card">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center"><i class="fas fa-th-large mr-2 text-blue-500"></i> Heatmap Tren Bulanan (2020-2025)</h3>
            <div id="heatmapContainer" class="overflow-x-auto">
                <!-- Heatmap akan di-generate di sini oleh JS -->
            </div>
            <p class="mt-3 text-xs text-gray-500">Klik sel untuk melihat detail trend.</p>
        </div>

        <!-- Bar Chart Frekuensi Trend -->
        <div class="col-span-1 lg:col-span-1 p-4 md:p-6 bg-white card">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center"><i class="fas fa-chart-bar mr-2 text-green-500"></i> Frekuensi Trend (Naik/Turun)</h3>
            <canvas id="barChart"></canvas>
        </div>

        <!-- Line Chart Kontinu -->
        <div class="col-span-1 lg:col-span-1 p-4 md:p-6 bg-white card">
            <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center"><i class="fas fa-chart-line mr-2 text-red-500"></i> Pergerakan Harga Kontinu (2020-2025)</h3>
            <canvas id="lineChartContinous"></canvas>
        </div>
    </div>

    <!-- Section 3: Detail Data dan Faktor Pemicu -->
    <section class="p-4 md:p-6 bg-white card">
        <h2 class="text-xl font-semibold mb-3 text-gray-800 flex items-center"><i class="fas fa-table mr-2 text-purple-600"></i> Detail Data Historis & Faktor Pemicu</h2>
        <div class="overflow-x-auto">
            <table class="table table-hover table-striped text-sm" id="dataTable">
                <thead class="bg-gray-100">
                    <tr>
                        <th scope="col" class="py-2">Bulan/Tahun</th>
                        <th scope="col">Trend</th>
                        <th scope="col">Deskripsi</th>
                        <th scope="col">Faktor Pemicu</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data akan diisi di sini oleh JS -->
                </tbody>
            </table>
        </div>
        
    </section>

    <footer class="mt-8 text-center text-gray-500 text-xs">
        &copy; 2025 XAU/USD Dashboard. Didukung oleh Chart.js, Bootstrap, Tailwind, dan Google Gemini API.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ******************************************************************
    // ** DATASET LOKAL (Data Contoh Historis XAU/USD 2020-2025) **
    // ******************************************************************
    const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];

    // Data Historis Bulanan (untuk Heatmap, Bar Chart, dan Tabel)
    // Struktur: { monthYear: 'Bulan-Tahun', year: 2020, month: 1, trend: 'Naik'/'Turun'/'Netral', desc: 'Deskripsi singkat', factor: 'Faktor pemicu' }
    const rawData = [
        // 2020
        { monthYear: 'Jan-2020', year: 2020, month: 1, trend: 'Naik', desc: 'Ketegangan geopolitik awal tahun', factor: 'Eskalasi konflik Timur Tengah' },
        { monthYear: 'Feb-2020', year: 2020, month: 2, trend: 'Netral', desc: 'Konsolidasi setelah lonjakan awal', factor: 'Fokus pasar ke data ekonomi AS' },
        { monthYear: 'Mar-22', year: 2020, month: 3, trend: 'Turun', desc: 'Penjualan likuidasi besar-besaran (Pandemi)', factor: 'Panic selling, Dolar AS menguat' },
        { monthYear: 'Apr-2020', year: 2020, month: 4, trend: 'Naik', desc: 'Stimulus fiskal dan moneter global', factor: 'Pelonggaran kuantitatif The Fed' },
        { monthYear: 'Mei-2020', year: 2020, month: 5, trend: 'Naik', desc: 'Ketidakpastian ekonomi jangka panjang', factor: 'Ketakutan resesi global' },
        { monthYear: 'Jun-2020', year: 2020, month: 6, trend: 'Naik', desc: 'Suku bunga mendekati nol', factor: 'Inflasi jangka panjang diharapkan' },
        { monthYear: 'Jul-2020', year: 2020, month: 7, trend: 'Naik', desc: 'Dolar melemah signifikan', factor: 'Indeks Dolar AS turun tajam' },
        { monthYear: 'Agu-2020', year: 2020, month: 8, trend: 'Netral', desc: 'Mencapai puncak historis, kemudian terkoreksi', factor: 'Ambil untung skala besar' },
        { monthYear: 'Sep-2020', year: 2020, month: 9, trend: 'Turun', desc: 'Harapan vaksin meningkatkan selera risiko', factor: 'Perkembangan uji coba vaksin' },
        { monthYear: 'Okt-2020', year: 2020, month: 10, trend: 'Turun', desc: 'Fokus pasar ke pemilu AS', factor: 'Penguatan Dolar AS sementara' },
        { monthYear: 'Nov-2020', year: 2020, month: 11, trend: 'Turun', desc: 'Kabar vaksin sukses', factor: 'Investor pindah ke aset berisiko (ekuitas)' },
        { monthYear: 'Des-2020', year: 2020, month: 12, trend: 'Naik', desc: 'Paket stimulus baru AS', factor: 'Pencetakan uang tambahan' },

        // 2021
        { monthYear: 'Jan-2021', year: 2021, month: 1, trend: 'Turun', desc: 'Imbal hasil obligasi AS naik', factor: 'Kekuatan Dolar AS' },
        { monthYear: 'Feb-2021', year: 2021, month: 2, trend: 'Turun', desc: 'Selera risiko membaik', factor: 'Program vaksinasi masif' },
        { monthYear: 'Mar-2021', year: 2021, month: 3, trend: 'Naik', desc: 'Kekhawatiran inflasi kembali', factor: 'Pengurangan suplai komoditas' },
        { monthYear: 'Apr-2021', year: 2021, month: 4, trend: 'Naik', desc: 'The Fed mempertahankan kebijakan dovish', factor: 'Suku bunga tetap rendah' },
        { monthYear: 'Mei-2021', year: 2021, month: 5, trend: 'Naik', desc: 'Data CPI AS melonjak di atas ekspektasi', factor: 'Inflasi tinggi' },
        { monthYear: 'Jun-2021', year: 2021, month: 6, trend: 'Turun', desc: 'The Fed mengisyaratkan tapering (hawkish)', factor: 'Reaksi pasar terhadap FOMC' },
        { monthYear: 'Jul-2021', year: 2021, month: 7, trend: 'Turun', desc: 'Dolar AS menguat tajam', factor: 'Reli Dolar AS' },
        { monthYear: 'Agu-2021', year: 2021, month: 8, trend: 'Naik', desc: 'Variant Delta menyebar', factor: 'Ketidakpastian Pandemi' },
        { monthYear: 'Sep-2021', year: 2021, month: 9, trend: 'Turun', desc: 'Kekuatan Dolar karena Tapering', factor: 'Retorika Hawkish The Fed' },
        { monthYear: 'Okt-2021', year: 2021, month: 10, trend: 'Naik', desc: 'Kenaikan harga energi dan komoditas', factor: 'Lonjakan harga minyak' },
        { monthYear: 'Nov-2021', year: 2021, month: 11, trend: 'Turun', desc: 'Ekspektasi kenaikan suku bunga', factor: 'Komentar The Fed yang Hawkish' },
        { monthYear: 'Des-2021', year: 2021, month: 12, trend: 'Naik', desc: 'Penutupan akhir tahun, pelemahan Dolar', factor: 'Sentimen liburan dan likuiditas rendah' },

        // 2022
        { monthYear: 'Jan-2022', year: 2022, month: 1, trend: 'Turun', desc: 'The Fed mulai bersiap untuk kenaikan suku bunga', factor: 'Persiapan pengetatan moneter' },
        { monthYear: 'Feb-2022', year: 2022, month: 2, trend: 'Naik', desc: 'Invasi Rusia ke Ukraina', factor: 'Ketegangan geopolitik dan flight-to-safety' },
        { monthYear: 'Mar-2022', year: 2022, month: 3, trend: 'Netral', desc: 'Konsolidasi di level tinggi setelah perang', factor: 'Dampak sanksi vs. kenaikan suku bunga' },
        { monthYear: 'Apr-2022', year: 2022, month: 4, trend: 'Turun', desc: 'Dolar AS menguat sebagai safe haven', factor: 'Pengetatan moneter The Fed' },
        { monthYear: 'Mei-2022', year: 2022, month: 5, trend: 'Turun', desc: 'Suku bunga AS naik 50 bps', factor: 'Kenaikan suku bunga agresif' },
        { monthYear: 'Jun-2022', year: 2022, month: 6, trend: 'Turun', desc: 'Ekspektasi suku bunga Fed mencapai puncaknya', factor: 'Kekuatan Dolar AS, Yields Tinggi' },
        { monthYear: 'Jul-2022', year: 2022, month: 7, trend: 'Naik', desc: 'Resesi teknis di AS', factor: 'Kekhawatiran pertumbuhan ekonomi' },
        { monthYear: 'Agu-2022', year: 2022, month: 8, trend: 'Turun', desc: 'Retorika hawkish Jackson Hole', factor: 'Pidato Jerome Powell' },
        { monthYear: 'Sep-2022', year: 2022, month: 9, trend: 'Turun', desc: 'Inflasi AS masih tinggi', factor: 'The Fed terus agresif' },
        { monthYear: 'Okt-2022', year: 2022, month: 10, trend: 'Naik', desc: 'Harapan pivot The Fed', factor: 'Data ketenagakerjaan melambat' },
        { monthYear: 'Nov-2022', year: 2022, month: 11, trend: 'Naik', desc: 'Rupiah menguat, Dolar melemah', factor: 'Laporan CPI AS di bawah ekspektasi' },
        { monthYear: 'Des-2022', year: 2022, month: 12, trend: 'Naik', desc: 'China melonggarkan kebijakan nol-COVID', factor: 'Permintaan fisik emas meningkat' },

        // 2023
        { monthYear: 'Jan-2023', year: 2023, month: 1, trend: 'Naik', desc: 'Ekspektasi suku bunga mencapai puncak', factor: 'Pelemahan Dolar AS berlanjut' },
        { monthYear: 'Feb-2023', year: 2023, month: 2, trend: 'Turun', desc: 'Data ekonomi AS yang kuat', factor: 'Ekspektasi The Fed lebih hawkish' },
        { monthYear: 'Mar-2023', year: 2023, month: 3, trend: 'Naik', desc: 'Krisis perbankan regional AS (SVB)', factor: 'Flight-to-safety ke emas' },
        { monthYear: 'Apr-2023', year: 2023, month: 4, trend: 'Naik', desc: 'Pelonggaran krisis perbankan, momentum naik', factor: 'Ketidakpastian sistemik' },
        { monthYear: 'Mei-2023', year: 2023, month: 5, trend: 'Turun', desc: 'Data pekerjaan AS yang kuat', factor: 'Dolar AS rebound' },
        { monthYear: 'Jun-2023', year: 2023, month: 6, trend: 'Turun', desc: 'The Fed mempertahankan suku bunga (pause)', factor: 'Yields obligasi naik' },
        { monthYear: 'Jul-2023', year: 2023, month: 7, trend: 'Naik', desc: 'Inflasi melambat, pasar berspekulasi akhir kenaikan', factor: 'Data CPI AS positif' },
        { monthYear: 'Agu-2023', year: 2023, month: 8, trend: 'Turun', desc: 'Imbal hasil obligasi AS 10-tahun melonjak', factor: 'Imbal hasil riil tinggi' },
        { monthYear: 'Sep-2023', year: 2023, month: 9, trend: 'Turun', desc: 'Suku bunga The Fed mencapai puncak', factor: 'Kekuatan Dolar AS ekstrem' },
        { monthYear: 'Okt-2023', year: 2023, month: 10, trend: 'Naik', desc: 'Konflik Israel-Hamas', factor: 'Ketegangan geopolitik besar' },
        { monthYear: 'Nov-2023', year: 2023, month: 11, trend: 'Naik', desc: 'Retorika The Fed yang dovish', factor: 'Harapan penurunan suku bunga' },
        { monthYear: 'Des-2023', year: 2023, month: 12, trend: 'Naik', desc: 'The Fed mengisyaratkan pemotongan suku bunga 2024', factor: 'Pelemahan Dolar signifikan' },

        // 2024
        { monthYear: 'Jan-2024', year: 2024, month: 1, trend: 'Turun', desc: 'Dolar AS menguat kembali setelah euforia Desember', factor: 'Ambil untung, data pekerjaan AS kuat' },
        { monthYear: 'Feb-2024', year: 2024, month: 2, trend: 'Netral', desc: 'Konsolidasi di sekitar level support', factor: 'Ketidakpastian waktu pemotongan suku bunga' },
        { monthYear: 'Mar-2024', year: 2024, month: 3, trend: 'Naik', desc: 'Rekor harga baru karena pembelian bank sentral', factor: 'Pembelian masif Bank Sentral' },
        { monthYear: 'Apr-2024', year: 2024, month: 4, trend: 'Turun', desc: 'Data inflasi AS yang panas', factor: 'Ekspektasi kenaikan suku bunga lagi' },
        { monthYear: 'Mei-2024', year: 2024, month: 5, trend: 'Naik', desc: 'Dolar AS melemah akibat pertumbuhan yang melambat', factor: 'Sentimen dovish sementara The Fed' },
        { monthYear: 'Jun-2024', year: 2024, month: 6, trend: 'Netral', desc: 'Menunggu keputusan Fed dan data CPI', factor: 'Konsolidasi sebelum NFP' },
        { monthYear: 'Jul-2024', year: 2024, month: 7, trend: 'Naik', desc: 'Data inflasi kembali melambat', factor: 'Spekulasi penurunan suku bunga di Q4' },
        { monthYear: 'Agu-2024', year: 2024, month: 8, trend: 'Naik', desc: 'Dolar AS melemah tajam', factor: 'Kekhawatiran pemilu AS' },
        { monthYear: 'Sep-2024', year: 2024, month: 9, trend: 'Turun', desc: 'Rally teknikal Dolar AS', factor: 'Ambil untung, koreksi harga' },
        { monthYear: 'Okt-2024', year: 2024, month: 10, trend: 'Naik', desc: 'Ketidakpastian politik jelang pemilu', factor: 'Flight-to-safety politik' },
        { monthYear: 'Nov-2024', year: 2024, month: 11, trend: 'Netral', desc: 'Reaksi pasar setelah pemilu AS', factor: 'Fokus ke kebijakan fiskal baru' },
        { monthYear: 'Des-2024', year: 2024, month: 12, trend: 'Naik', desc: 'Harapan pemotongan suku bunga 2025', factor: 'Pelemahan Dolar AS' },
        
        // 2025 (Hanya Jan-Jun, sebagai contoh)
        { monthYear: 'Jan-2025', year: 2025, month: 1, trend: 'Turun', desc: 'Suku bunga AS dipotong, Dolar menguat (Buy the rumour, sell the news)', factor: 'Realitas pemotongan suku bunga' },
        { monthYear: 'Feb-2025', year: 2025, month: 2, trend: 'Naik', desc: 'Inflasi kembali naik setelah pemotongan', factor: 'Tingkat inflasi di atas target Fed' },
        { monthYear: 'Mar-2025', year: 2025, month: 3, trend: 'Naik', desc: 'Pembelian bank sentral berkelanjutan', factor: 'Permintaan fisik dari Asia' },
        { monthYear: 'Apr-2025', year: 2025, month: 4, trend: 'Netral', desc: 'Konsolidasi level tinggi', factor: 'Stabilitas pasar setelah pemotongan suku bunga' },
        { monthYear: 'Mei-2025', year: 2025, month: 5, trend: 'Turun', desc: 'Dolar AS menguat ringan', factor: 'Data PDB yang mengejutkan' },
        { monthYear: 'Jun-2025', year: 2025, month: 6, trend: 'Naik', desc: 'Kekhawatiran defisit anggaran AS', factor: 'Kelemahan fiskal' },
    ];

    // Data Harga Kontinu (Untuk Line Chart)
    const priceData = [
        1550, 1600, 1580, 1500, 1650, 1700, 1800, 1950, 1920, 1850, 1830, 1780, // 2020
        1850, 1750, 1700, 1750, 1800, 1850, 1750, 1700, 1750, 1700, 1650, 1800, // 2021
        1850, 1750, 1900, 1880, 1800, 1750, 1700, 1750, 1700, 1650, 1750, 1850, // 2022
        1950, 2050, 2000, 2050, 2080, 2000, 1950, 2000, 1950, 1900, 2000, 2050, // 2023
        2150, 2100, 2100, 2300, 2200, 2250, 2250, 2350, 2400, 2300, 2350, 2300, // 2024
        2350, 2250, 2300, 2400, 2400, 2350, // 2025 (Juni)
    ];

    // Helper untuk menentukan warna berdasarkan trend
    function getTrendClass(trend) {
        if (trend === 'Naik') return 'bg-green-custom';
        if (trend === 'Turun') return 'bg-red-custom';
        if (trend === 'Netral') return 'bg-yellow-custom';
        return 'bg-gray-custom';
    }

    // ******************************************************************
    // ** FUNGSI CHART.JS DAN TABLE (Logika tidak berubah) **
    // ******************************************************************

    function drawHeatmap() {
        const years = [2020, 2021, 2022, 2023, 2024, 2025];
        const container = document.getElementById('heatmapContainer');
        let html = '<table class="w-full text-center border border-gray-300">';
        
        // Header Bulan
        html += '<thead><tr><th class="p-2 bg-gray-200 border-b border-gray-300">Tahun</th>';
        monthLabels.forEach(m => {
            html += `<th class="p-2 bg-gray-200 border-b border-gray-300">${m}</th>`;
        });
        html += '</tr></thead><tbody>';

        years.forEach(year => {
            html += `<tr><td class="p-2 font-bold bg-gray-100 border-r border-gray-300">${year}</td>`;
            
            for (let month = 1; month <= 12; month++) {
                const dataPoint = rawData.find(d => d.year === year && d.month === month);
                
                let trend = '';
                let cellClass = 'bg-gray-custom';
                let tooltip = '';

                if (dataPoint) {
                    trend = dataPoint.trend.charAt(0);
                    cellClass = getTrendClass(dataPoint.trend);
                    tooltip = `data-bs-toggle="tooltip" data-bs-placement="top" title="${dataPoint.monthYear}: Trend ${dataPoint.trend}. Faktor: ${dataPoint.factor}"`;
                } else if (year === 2025 && month > 6) {
                    // Hanya sampai Juni 2025
                    cellClass = 'bg-gray-100'; 
                }

                html += `<td class="p-0 border border-gray-200">
                            <div class="heatmap-cell ${cellClass}" ${tooltip}>
                                ${trend}
                            </div>
                         </td>`;
            }
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        
        // Initialize tooltips (requires Bootstrap JS)
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(tooltipEl => {
            new bootstrap.Tooltip(tooltipEl);
        });
    }

    function drawBarChart() {
        Chart.register(ChartDataLabels); 
        const trendCounts = rawData.reduce((acc, curr) => {
            acc[curr.trend] = (acc[curr.trend] || 0) + 1;
            return acc;
        }, {});

        const data = {
            labels: ['Naik', 'Turun', 'Netral'],
            datasets: [{
                label: 'Jumlah Kemunculan Trend Bulanan (2020-2025)',
                data: [trendCounts['Naik'] || 0, trendCounts['Turun'] || 0, trendCounts['Netral'] || 0],
                backgroundColor: [
                    'rgba(25, 135, 84, 0.7)', 
                    'rgba(220, 53, 69, 0.7)',  
                    'rgba(255, 193, 7, 0.7)'   
                ],
                borderColor: [
                    'rgba(25, 135, 84, 1)', 
                    'rgba(220, 53, 69, 1)', 
                    'rgba(255, 193, 7, 1)'
                ],
                borderWidth: 1
            }]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Jumlah Bulan' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => value,
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                }
            },
            plugins: [ChartDataLabels]
        };

        new Chart(document.getElementById('barChart'), config);
    }

    function getContinousPriceData() {
        const labels = rawData.map(d => d.monthYear);
        return { labels: labels, prices: priceData };
    }

    function drawLineChartContinous(data) {
        const config = {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Harga Penutupan Bulanan (USD)',
                    data: data.prices,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    pointRadius: 3,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Harga XAU/USD' }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            }
        };

        new Chart(document.getElementById('lineChartContinous'), config);
    }

    function populateTable() {
        const tableBody = document.querySelector('#dataTable tbody');
        tableBody.innerHTML = ''; 

        const reversedData = [...rawData].reverse();

        reversedData.forEach(item => {
            const row = tableBody.insertRow();
            
            row.insertCell().textContent = item.monthYear;
            
            const trendCell = row.insertCell();
            const badge = document.createElement('span');
            badge.textContent = item.trend;
            badge.className = `badge rounded-pill ${item.trend === 'Naik' ? 'bg-success' : item.trend === 'Turun' ? 'bg-danger' : 'bg-warning text-dark'}`;
            trendCell.appendChild(badge);

            row.insertCell().textContent = item.desc;
            row.insertCell().textContent = item.factor;
        });
    }

    // **************************************************
    // ** LOGIKA PANGGILAN API BARU (Ke Serverless Function) **
    // **************************************************

    function formatDataForGemini() {
        let formatted = "Tabel Data Historis XAU/USD (Bulan, Trend, Deskripsi, Faktor):\n\n";
        rawData.forEach(item => {
            formatted += `- ${item.monthYear}: Trend **${item.trend}**. Deskripsi: ${item.desc}. Faktor: ${item.factor}.\n`;
        });
        return formatted;
    }

    /**
     * Memanggil Vercel Serverless Function untuk menganalisis data historis lokal secara aman.
     * @param {string} query Kueri analisis dari pengguna.
     * @returns {Promise<string>} Hasil analisis dalam format Markdown.
     */
    async function analyzeLocalDataWithGemini(query) {
        
        const historicalData = formatDataForGemini();
        // ** PERUBAHAN KRUSIAL: Memanggil endpoint serverless yang aman **
        const apiUrl = '/api/analyze'; 

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query, historicalData }) // Kirim kueri dan data ke server
            });

            const result = await response.json();

            if (!response.ok) {
                // Tangani error dari serverless function
                const errorDetails = result.details || result.error || 'Serverless function gagal merespons.';
                return `[FATAL ERROR - SERVER] Status ${response.status}: ${errorDetails}`;
            }

            // 4. Format Output
            let output = `**[ANALISIS DATA LOKAL OLEH GEMINI AI]**\n`;
            output += `(Analisis ini didasarkan pada data Heatmap statis tahun 2020-2025, bukan data pasar real-time.)\n\n`;
            output += result.text; // Ambil teks dari respons JSON
            output += `\n\n---\n[EXECUTION COMPLETE] Analisis berdasarkan data historis yang tersedia.`;
            
            return output;

        } catch (error) {
            console.error('Error fetching Vercel API:', error);
            return `[FATAL ERROR - JARINGAN] Gagal menghubungi serverless function. Cek konsol browser atau log Vercel: ${error.message}`;
        }
    }


    // **************************************************
    // ** LOGIKA DOM DAN INITIALISASI **
    // **************************************************

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Inisialisasi Chart Statis
        drawHeatmap();
        drawBarChart();
        populateTable();
        const continousData = getContinousPriceData();
        drawLineChartContinous(continousData);
        
        // 2. Logika AI Terminal
        const newsQueryInput = document.getElementById('newsQuery');
        const searchNewsBtn = document.getElementById('searchNewsBtn');
        const searchStatus = document.getElementById('searchStatus');
        const newsResultPre = document.getElementById('newsResult');

        // Awalnya nonaktifkan tombol sampai ada input
        searchNewsBtn.disabled = true;

        newsQueryInput.addEventListener('input', () => {
            searchNewsBtn.disabled = newsQueryInput.value.trim() === '';
        });

        searchNewsBtn.addEventListener('click', async () => {
            const query = newsQueryInput.value.trim();
            if (!query) return;

            searchNewsBtn.disabled = true;
            searchStatus.style.display = 'block';
            searchStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> **[STATUS]** Mengirim kueri ke Google Gemini (via Serverless Function)...';
            newsResultPre.textContent = `[CONSOLE] Menganalisis data historis untuk kueri: ${query} ...`;
            
            try {
                const aiResponse = await analyzeLocalDataWithGemini(query);
                newsResultPre.innerHTML = aiResponse; // innerHTML agar markdown Gemini terbaca
            } catch (error) {
                console.error('Error during AI process:', error);
                newsResultPre.textContent = `[FATAL ERROR] Kesalahan tak terduga: ${error.message}`;
            } finally {
                searchStatus.style.display = 'none';
                 // Aktifkan tombol kembali jika input tidak kosong
                 searchNewsBtn.disabled = newsQueryInput.value.trim() === '';
            }
        });
    });
    </script>
</body>
</html>
